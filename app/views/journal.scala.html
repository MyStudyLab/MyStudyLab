@(username: String)(implicit messages: Messages)

@loggedInTemplate("Journal") {
    <link href="@routes.Assets.at("stylesheets/journal.css")" rel="stylesheet" type="text/css">
} {

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-8 col-sm-offset-2">
                <div class="raised-element text-justify partial-border center-text-content">
                    <form id="journal-entry-form">
                        <div class="form-group">
                            <label class="sr-only" for="journal-entry-input">Journal</label>
                            <textarea name="text" class="form-control" id="journal-entry-input" form="journal-entry-form" placeholder="Dear Journal..." autocomplete="off" required></textarea>
                        </div>

                        <button type="submit" id="journal-entry-input-button" class="transparent-button"><i class="fa fa-paper-plane-o fa-2x"></i></button>
                    </form>
                </div>

                <div id='dashboard-map'></div>

                <div id="past-journal-entries">

                </div>
            </div>
        </div>
    </div>


        <!-- Moment JS -->
    <script src="@routes.Assets.at("/javascripts/moment.js")"></script>
    <script src="@routes.Assets.at("/javascripts/moment-timezone-10-20.js")"></script>

    <script src="@routes.Assets.at("/javascripts/JournalEntryList.js")"></script>
    <script src="@routes.Assets.at("/javascripts/FormHandlers.js")"></script>

        <!-- Mapbox -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.css' rel='stylesheet'/>

    <script>
            'use strict';

            let entryList;

            // Set up handlers and load journal entries
            $(function () {

                // Set up the handler for journal entry submission
                submitWithGeo("#journal-entry-form", "@routes.JournalEntries.addJournalEntry()",
                        (responseData, formData, formElem) => {

                            // Clear the form after submission
                            document.getElementById('journal-entry-form').reset();

                            // Add the new entry to the list
                            let journalEntry = {};

                            journalEntry['timestamp'] = responseData['timestamp'];

                            // Add proper form fields
                            formData.forEach((field) => {
                                journalEntry[field['name']] = field['value'];
                            });

                            entryList.add(journalEntry);
                        }
                );

                $.ajax({
                    type: "get",
                    url: "@controllers.routes.JournalEntries.getJournalEntries()",
                    dataType: "json",
                    success: function (responseData, textResponse, jqXHR) {

                        if (responseData['success'] === true) {

                            entryList = new JournalEntryList("past-journal-entries", responseData['payload']);

                        } else {
                            console.log("There was a problem loading your journal entries")
                        }
                    }
                });
            });
    </script>

    <script>

            let map;

            // Get current position, then initialize map
            navigator.geolocation.getCurrentPosition((position) => {
                mapboxgl.accessToken = 'pk.eyJ1Ijoic2VudGllbnRzYWlsb3IiLCJhIjoiY2o5MjQ0dGhqM2V1cjJ3cDZwbjB2YWtlaSJ9.H7_wVqAUVOu8bJYmwc1rtg';
                map = new mapboxgl.Map({
                    container: 'dashboard-map',
                    style: 'mapbox://styles/mapbox/light-v9',
                    zoom: 13,
                    center: [position.coords.longitude, position.coords.latitude]
                });


                map.on('load', () => {

                    map.addSource("journals", {
                        type: 'geojson',
                        data: '/json/geoJsonJournal'
                    });

                    map.addLayer({
                        'id': 'journals',
                        'type': 'circle',
                        'source': 'journals',
                        'paint': {
                            'circle-color': '#80bdfd',
                            // make circles larger as the user zooms from z12 to z22
                            'circle-radius': {
                                'base': 4,
                                'stops': [
                                    [12, 3.5],
                                    [20, 3]
                                ]
                            },
                            'circle-opacity': 0.75
                        }
                    });

                    map.on('click', 'journals', function (e) {
                        new mapboxgl.Popup()
                                .setLngLat(e.features[0].geometry.coordinates)
                                .setHTML(e.features[0].properties.text)
                                .addTo(map);
                    });

                    // Change the cursor to a pointer when the mouse is over the places layer.
                    map.on('mouseenter', 'journals', function () {
                        map.getCanvas().style.cursor = 'pointer';
                    });

                    // Change it back to a pointer when it leaves.
                    map.on('mouseleave', 'journals', function () {
                        map.getCanvas().style.cursor = '';
                    });

                });


            }, (err) => {
                // Error handling
                console.log(err);
            }, {
                "maximumAge": 10 * 1000
            })


    </script>
}