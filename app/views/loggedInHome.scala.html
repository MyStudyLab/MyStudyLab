@(username: String)(implicit messages: Messages)

@loggedInTemplate("Home") {

    <script src="@routes.Assets.at("javascripts/StudyClock.js")"></script>

    <p>Welcome to Study Lab, @username</p>

    <div id="study-clock"></div>

    <div class="studylab-entry-form">

        <form id="study-start-form" hidden>
            <input id="study-start-username-input" name="username" value="@username" type="text" required hidden>
            <input id="study-start-subject-input" name="subject" type="text">
            <button type="submit" class="btn btn-default">start</button>
        </form>

        <form id="study-stop-form" hidden>
            <input id="study-stop-username-input" name="username" value="@username" type="text" hidden>
            <input id="study-stop-message-input" name="message" type="text">
            <button type="submit" class="btn btn-default">stop</button>
        </form>

        <form id="study-cancel-form" hidden>
            <input id="study-cancel-username-input" name="username" value="@username" type="text" required hidden>
            <button type="submit" class="btn btn-default">cancel</button>
        </form>

        <form id="add-subject-form">
            <input id="add-subject-username-input" name="username" value="@username" type="text" required hidden>
            <input id="add-subject-subject-input" name="subject" type="text">
            <input id="add-subject-description-input" name="description" type="text">
            <button type="submit" class="btn btn-default">add</button>
        </form>

    </div>

    <script>

            let stopwatch = new Stopwatch("study-clock");

            // Initialize the page according to the user's status
            jQuery.ajax({
                url: "@routes.Sessions.userStatus(username)",
                type: "get",
                dataType: "json",
                success: function (data, textStatus, response) {

                    console.log(response.responseText);

                    console.log(data);

                    if (data['payload']['isStudying']) {

                        // Start the stopwatch
                        stopwatch.startFrom(data['payload']['start']);

                        // Unhide the stop and cancel forms
                        $("#study-stop-form").removeAttr("hidden");
                        $("#study-cancel-form").removeAttr("hidden");
                    } else {

                        stopwatch.displayZero();

                        // Unhide the start form
                        $("#study-start-form").removeAttr("hidden");
                    }
                }
            })

    </script>

    <script>
            $(function () {
                $("#study-start-form").on("submit", function (e) {

                    // TODO: prevent fields from clearing

                    e.preventDefault();

                    $.ajax({
                        type: "post",
                        url: "@controllers.routes.Sessions.startSession()",
                        data: $("#study-start-form").serialize(),
                        dataType: "json",
                        complete: function (request, textStatus) {

                            if (request.status === 200) {

                                console.log(request.responseText);

                                // Parse the response text as JSON
                                let data = JSON.parse(request.responseText);
                                console.log(data);

                                if (data['success'] === true) {

                                    // TODO: Return the session start time in the payload

                                    // Start the stopwatch
                                    stopwatch.start();

                                    // Unhide the stop and cancel forms
                                    $("#study-stop-form").removeAttr("hidden");
                                    $("#study-cancel-form").removeAttr("hidden");

                                    // Hide and clear the start form
                                    $("#study-start-form").attr("hidden", true);
                                    $("#study-start-subject-input").val("");
                                } else {

                                }
                            }
                        }
                    });
                });
            });


            $(function () {
                $("#study-stop-form").on("submit", function (e) {

                    // TODO: prevent fields from clearing

                    e.preventDefault();

                    $.ajax({
                        type: "post",
                        url: "@controllers.routes.Sessions.stopSession()",
                        data: $("#study-stop-form").serialize(),
                        dataType: "json",
                        complete: function (request, textStatus) {

                            if (request.status === 200) {

                                console.log(request.responseText);

                                // Parse the response text as JSON
                                let data = JSON.parse(request.responseText);

                                console.log(data);

                                if (data['success'] === true) {

                                    $("#study-stop-message-input").val("");

                                    // Reset the clock
                                    stopwatch.reset();

                                    $("#study-start-form").removeAttr("hidden");
                                    $("#study-stop-form").attr("hidden", true);
                                    $("#study-cancel-form").attr("hidden", true);
                                } else {

                                }
                            }
                        }
                    });
                });
            });


            $(function () {
                $("#study-cancel-form").on("submit", function (e) {

                    // TODO: prevent fields from clearing

                    e.preventDefault();

                    $.ajax({
                        type: "post",
                        url: "@controllers.routes.Sessions.cancelSession()",
                        data: $("#study-cancel-form").serialize(),
                        dataType: "json",
                        complete: function (request, textStatus) {

                            if (request.status === 200) {

                                console.log(request.responseText);

                                // Parse the response text as JSON
                                let data = JSON.parse(request.responseText);

                                if (data['success'] === true) {
                                    console.log(data);
                                    $("#study-stop-message-input").val("");

                                    // Reset the clock
                                    stopwatch.reset();

                                    $("#study-start-form").removeAttr("hidden");
                                    $("#study-stop-form").attr("hidden", true);
                                    $("#study-cancel-form").attr("hidden", true);
                                } else {

                                }
                            }
                        }
                    });
                });
            });


            $(function () {
                $("#add-subject-form").on("submit", function (e) {

                    // TODO: prevent fields from clearing

                    e.preventDefault();

                    $.ajax({
                        type: "post",
                        url: "@controllers.routes.Sessions.addSubject()",
                        data: $("#add-subject-form").serialize(),
                        dataType: "json",
                        complete: function (request, textStatus) {

                            if (request.status === 200) {

                                console.log(request.responseText);

                                // Parse the response text as JSON
                                let data = JSON.parse(request.responseText);

                                if (data['success'] === true) {
                                    console.log(data);
                                    // Clear the form inputs
                                    $("#add-subject-subject-input").val("");
                                    $("#add-subject-description-input").val("");
                                } else {
                                    // Handle errors: subject already added, etc.
                                }
                            }
                        }
                    });
                });
            });

    </script>
}